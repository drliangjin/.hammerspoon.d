#!/usr/bin/env bash

# macOS only
[[ ! "$(uname -s)" = "Darwin" ]] && \
echo "Hammerspoon is only available for macOS!" && \
exit 1

# Homebrew URL
BREW_URL="https://raw.githubusercontent.com/Homebrew/install/master/install"

# SpoonInstall URL
SPOONS_URL="https://github.com/Hammerspoon/Spoons/raw/master/Spoons/"
SPOON_ZIP="SpoonInstall.spoon.zip"
SPOON=${SPOON_ZIP%%.*} # trim the longest match from the end

# Git Repo
GH_USER="drliangjin"
GH_REPO=".hammerspoon.d"
GH_BRANCH="master"
HS_DIR="$HOME/${GH_REPO}"
SPOONS_DIR=$HS_DIR/Spoons
# symlink
LINK_DIR="$HOME/.hammerspoon"

function command_exists() {
  command -v $1 > /dev/null 2>&1
}

# Homebrew
function install_brew() {
  if ! command_exists brew; then
    /usr/bin/ruby -e "$(curl -fsSL ${BREW_URL})" > /dev/null 2>&1
    if [[ $? != 0 ]]; then
      echo " => unable to install Homebrew!"
      exit 1
    fi
  fi
}

function download_spoon() {
  echo "Installing Spoon: ${SPOON}..."
  mkdir -p $SPOONS_DIR
  curl -fsSL ${SPOONS_URL}${SPOON_ZIP} -o $HOME/Downloads/$SPOON_ZIP
  unzip $HOME/Downloads/$SPOON_ZIP -d $SPOONS_DIR
}

function install_hammerspoon() {
  echo "Installing Hammerspoon..."
  install_brew && brew cask install hammerspoon > /dev/null 2>&1 && \
  echo "Installing Hammerspoon...done"
  
  echo "Deploying Hammerspoon configuration..."
  git clone -q -b ${GH_BRANCH} https://github.com/${GH_USER}/${GH_REPO}.git && \
  ln -sf ${HS_DIR} ${LINK_DIR} && \
  echo "Deploying Hammerspoon configuration...done"
  
  echo "Installing Spoon: ${SPOON}..."
  mkdir -p $SPOONS_DIR
  curl -fsSL ${SPOONS_URL}${SPOON_ZIP} -o $HOME/Downloads/$SPOON_ZIP
  unzip -q $HOME/Downloads/$SPOON_ZIP -d $SPOONS_DIR
  echo "Installing Spoon: ${SPOON}...done"
}

install_hammerspoon
